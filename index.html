<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .loader {
            border: 3px solid rgba(226, 232, 240, 0.3);
            border-left-color: #0284c7;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden h-screen flex selection:bg-brand-100 selection:text-brand-900">

    <!-- App Root -->
    <div id="app" class="flex w-full h-full">
        <!-- Initial Loading State -->
        <div class="m-auto flex flex-col items-center gap-6 animate-pulse">
            <div class="w-16 h-16 bg-brand-100 rounded-xl flex items-center justify-center text-brand-600 shadow-lg shadow-brand-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </div>
            <div class="text-slate-400 font-medium tracking-wide text-sm">INITIALIZING WORKSPACE</div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 border border-slate-100"></div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, serverTimestamp, query, orderBy, setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUihvWOpQv6CtpP0DzoGxO9Bi77gFVLdc",
            authDomain: "class-store-d5966.firebaseapp.com",
            projectId: "class-store-d5966",
            storageBucket: "class-store-d5966.firebasestorage.app",
            messagingSenderId: "697447403447",
            appId: "1:697447403447:web:cd7f70935a3e16a2bba232"
        };

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Management ---
        const state = {
            user: null,
            view: 'loading', // 'loading' | 'login' | 'dashboard' | 'project-detail'
            authMode: 'login', // 'login' | 'signup'
            sidebarOpen: true,
            activeProject: null,
            projectSubTab: 'overview', // 'overview' | 'tasks' | 'notes' | 'resources' | 'files'
            isUploading: false,
            searchQuery: '',
            
            // Data
            hotlinks: [],
            projects: [],
            activeProjectFiles: [],
            activeProjectTasks: [], 

            // Unsubscribe functions
            unsubHotlinks: null,
            unsubProjects: null,
            unsubFiles: null
        };

        // --- Toast System ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border text-sm font-medium transform transition-all duration-300 translate-y-10 opacity-0 ${
                type === 'success' ? 'bg-white border-green-100 text-green-700' : 
                type === 'error' ? 'bg-white border-red-100 text-red-700' : 'bg-white border-slate-100 text-slate-700'
            }`;
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info';
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i><span>${message}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // --- Auth & Listeners ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                state.view = 'dashboard';
                setupListeners(user.uid);
            } else {
                cleanupListeners();
                state.user = null;
                state.view = 'login';
                state.projects = [];
                state.hotlinks = [];
                render();
            }
        });

        function cleanupListeners() {
            if (state.unsubHotlinks) state.unsubHotlinks();
            if (state.unsubProjects) state.unsubProjects();
            if (state.unsubFiles) state.unsubFiles();
        }

        function setupListeners(uid) {
            const hotlinksRef = query(collection(db, 'users', uid, 'hotlinks'), orderBy('createdAt', 'desc'));
            state.unsubHotlinks = onSnapshot(hotlinksRef, (snap) => {
                state.hotlinks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render(); // Efficient enough for this scale
            });

            const projectsRef = query(collection(db, 'users', uid, 'projects'), orderBy('createdAt', 'desc'));
            state.unsubProjects = onSnapshot(projectsRef, (snap) => {
                state.projects = snap.docs.map(d => {
                    const data = d.data();
                    return {
                        id: d.id, 
                        tasks: [], 
                        notes: '', 
                        priority: 'Low',
                        ...data
                    };
                });
                
                if (state.activeProject) {
                    const fresh = state.projects.find(p => p.id === state.activeProject.id);
                    if (fresh) {
                        state.activeProject = fresh;
                    } else {
                        state.activeProject = null;
                        state.view = 'dashboard';
                        showToast('Project was deleted', 'info');
                    }
                }
                render();
            });
        }

        function setupFileListener(projectId) {
            if (state.unsubFiles) state.unsubFiles();
            const filesRef = query(collection(db, 'users', state.user.uid, 'projects', projectId, 'files'), orderBy('createdAt', 'desc'));
            state.unsubFiles = onSnapshot(filesRef, (snap) => {
                state.activeProjectFiles = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.view === 'project-detail' && state.projectSubTab === 'files') {
                    render();
                }
            });
        }

        // --- Actions ---
        window.actions = {
            toggleAuthMode: () => {
                state.authMode = state.authMode === 'login' ? 'signup' : 'login';
                render();
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const btn = document.getElementById('auth-btn');
                
                btn.disabled = true;
                btn.innerHTML = '<div class="loader w-5 h-5 border-white/30 border-l-white"></div>';

                try {
                    if (state.authMode === 'signup') {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showToast('Account created successfully!');
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        showToast('Welcome back!');
                    }
                } catch (err) {
                    console.error(err);
                    showToast(formatAuthError(err.code), 'error');
                    btn.disabled = false;
                    btn.innerText = state.authMode === 'login' ? 'Sign In' : 'Create Account';
                }
            },

            logout: async () => {
                await signOut(auth);
                showToast('Signed out');
            },

            toggleSidebar: () => {
                state.sidebarOpen = !state.sidebarOpen;
                render();
            },
            
            setView: (view, project = null) => {
                state.view = view;
                state.searchQuery = ''; // Reset search
                
                if (project) {
                    state.activeProject = project;
                    state.projectSubTab = 'overview';
                    setupFileListener(project.id);
                } else {
                    state.activeProject = null;
                    state.activeProjectFiles = [];
                    if (state.unsubFiles) state.unsubFiles();
                }
                render();
            },

            setSubTab: (tab) => {
                state.projectSubTab = tab;
                render();
            },

            updateSearch: (val) => {
                state.searchQuery = val.toLowerCase();
                render();
            },

            // --- Modals ---
            openModal: (type, data = null) => {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                content.innerHTML = getModalContent(type, data);
                lucide.createIcons();
            },

            closeModal: () => {
                if (state.isUploading) return;
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            // --- Hotlinks ---
            addHotlink: async (e) => {
                e.preventDefault();
                const colorInputs = document.getElementsByName('color');
                let selectedColor = 'bg-white border-slate-200';
                for(let input of colorInputs) if(input.checked) selectedColor = input.value;

                try {
                    await addDoc(collection(db, 'users', state.user.uid, 'hotlinks'), {
                        title: e.target.title.value, 
                        url: e.target.url.value, 
                        color: selectedColor,
                        createdAt: serverTimestamp()
                    });
                    showToast('Shortcut added');
                    window.actions.closeModal();
                } catch(e) { showToast('Error adding shortcut', 'error'); }
            },

            deleteHotlink: async (id, e) => {
                e.stopPropagation();
                if(confirm('Remove this shortcut?')) {
                    await deleteDoc(doc(db, 'users', state.user.uid, 'hotlinks', id));
                    showToast('Shortcut removed');
                }
            },

            // --- Projects ---
            addProject: async (e) => {
                e.preventDefault();
                const form = e.target;
                const newProj = {
                    title: form.title.value,
                    description: form.description.value,
                    status: 'Planning',
                    priority: form.priority.value,
                    dueDate: form.dueDate.value || null,
                    resources: [],
                    tasks: [],
                    notes: '',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                try {
                    const ref = await addDoc(collection(db, 'users', state.user.uid, 'projects'), newProj);
                    window.actions.closeModal();
                    window.actions.setView('project-detail', {id: ref.id, ...newProj});
                    showToast('Project created successfully');
                } catch(err) { showToast('Error creating project', 'error'); }
            },

            updateProject: async (field, value) => {
                if (!state.activeProject) return;
                try {
                    await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), {
                        [field]: value,
                        updatedAt: serverTimestamp()
                    });
                    if (field !== 'notes') showToast('Project updated');
                } catch (err) { console.error(err); showToast('Update failed', 'error'); }
            },

            deleteProject: async (id) => {
                if(confirm('Are you sure? This will delete all project data including files.')) {
                    await deleteDoc(doc(db, 'users', state.user.uid, 'projects', id));
                    window.actions.setView('dashboard');
                    showToast('Project deleted');
                }
            },

            // --- Tasks ---
            addTask: async (e) => {
                e.preventDefault();
                const text = e.target.task.value;
                if (!text.trim()) return;
                
                const newTask = { id: crypto.randomUUID(), text, completed: false, createdAt: new Date().toISOString() };
                const updatedTasks = [newTask, ...(state.activeProject.tasks || [])];
                
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { tasks: updatedTasks });
                e.target.reset();
            },

            toggleTask: async (taskId) => {
                const tasks = state.activeProject.tasks.map(t => 
                    t.id === taskId ? { ...t, completed: !t.completed } : t
                );
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { tasks });
            },

            deleteTask: async (taskId) => {
                const tasks = state.activeProject.tasks.filter(t => t.id !== taskId);
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { tasks });
            },

            // --- Resources ---
            addResource: async (e) => {
                e.preventDefault();
                const newResource = { id: crypto.randomUUID(), title: e.target.title.value, url: e.target.url.value, createdAt: new Date().toISOString() };
                const updatedResources = [...(state.activeProject.resources || []), newResource];
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
                window.actions.closeModal();
                showToast('Resource added');
            },

            deleteResource: async (resId) => {
                const updatedResources = state.activeProject.resources.filter(r => r.id !== resId);
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
                showToast('Resource removed');
            },

            // --- Files ---
            triggerFileUpload: () => document.getElementById('file-upload-input').click(),

            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;
                
                state.isUploading = true;
                const container = document.getElementById('upload-area');
                container.innerHTML = `
                    <div class="flex flex-col items-center py-8 animate-pulse">
                        <div class="loader mb-4 border-brand-500 border-l-transparent"></div>
                        <p class="text-sm font-medium text-slate-700">Uploading <span class="text-brand-600">${file.name}</span>...</p>
                    </div>
                `;

                try {
                    const fileId = crypto.randomUUID();
                    const storagePath = `users/${state.user.uid}/projects/${state.activeProject.id}/${fileId}_${file.name}`;
                    const storageRef = ref(storage, storagePath);

                    await uploadBytes(storageRef, file);
                    const downloadUrl = await getDownloadURL(storageRef);

                    await addDoc(collection(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files'), {
                        name: file.name, type: file.type, size: file.size, url: downloadUrl, storagePath: storagePath, createdAt: serverTimestamp()
                    });

                    state.isUploading = false;
                    window.actions.closeModal();
                    showToast('File uploaded successfully');
                } catch (error) {
                    console.error(error);
                    showToast('Upload failed', 'error');
                    state.isUploading = false;
                    window.actions.closeModal();
                }
            },

            deleteFile: async (fileId, storagePath) => {
                if(!confirm('Delete file permanently?')) return;
                try {
                    if (storagePath) await deleteObject(ref(storage, storagePath)).catch(e => console.warn(e));
                    await deleteDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files', fileId));
                    showToast('File deleted');
                } catch (error) { showToast('Delete failed', 'error'); }
            },

            saveNotes: async () => {
                const noteContent = document.getElementById('project-notes').value;
                const btn = document.getElementById('save-notes-btn');
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = `<span class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-white/50 border-t-white rounded-full animate-spin"></div> Saving...</span>`;

                await actions.updateProject('notes', noteContent);
                
                setTimeout(() => {
                    btn.innerHTML = `<span class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> Saved</span>`;
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btn.classList.remove('bg-brand-600', 'hover:bg-brand-700');
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.classList.add('bg-brand-600', 'hover:bg-brand-700');
                        lucide.createIcons();
                    }, 2000);
                }, 500);
            }
        };

        // --- Helpers ---
        function formatAuthError(code) {
            const map = {
                'auth/invalid-email': 'Invalid email address.',
                'auth/user-not-found': 'No account found.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/email-already-in-use': 'Email already registered.',
                'auth/weak-password': 'Password too weak.'
            };
            return map[code] || 'Authentication failed.';
        }

        function getStatusColor(status) {
            const colors = {
                'Active': 'bg-emerald-100 text-emerald-700 border-emerald-200',
                'Planning': 'bg-blue-100 text-blue-700 border-blue-200',
                'Completed': 'bg-slate-100 text-slate-600 border-slate-200',
                'On Hold': 'bg-amber-100 text-amber-700 border-amber-200'
            };
            return colors[status] || colors['Planning'];
        }

        function getPriorityBadge(priority) {
            const colors = {
                'High': 'text-red-600 bg-red-50 border-red-100',
                'Medium': 'text-orange-600 bg-orange-50 border-orange-100',
                'Low': 'text-slate-600 bg-slate-50 border-slate-100'
            };
            return `<span class="px-2 py-0.5 rounded text-xs border ${colors[priority] || colors['Low']}">${priority || 'Low'}</span>`;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'No Date';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getDomain(url) {
            try {
                return new URL(url).hostname;
            } catch (e) {
                return 'link';
            }
        }

        // --- Render Functions ---
        function render() {
            const app = document.getElementById('app');
            if (state.view === 'loading') return;
            
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderSidebar()}
                    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
                        ${state.view === 'dashboard' ? renderDashboard() : renderProjectDetail()}
                    </main>
                `;
            }
            lucide.createIcons();
        }

        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `
            <div class="min-h-screen w-full flex items-center justify-center bg-[#f8fafc] p-4 relative overflow-hidden">
                <div class="absolute -top-40 -right-40 w-96 h-96 bg-brand-200/50 rounded-full blur-3xl"></div>
                <div class="absolute top-40 -left-20 w-72 h-72 bg-purple-200/50 rounded-full blur-3xl"></div>
                
                <div class="bg-white/80 backdrop-blur-xl p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-md border border-white z-10 fade-in">
                    <div class="text-center mb-8">
                        <div class="w-14 h-14 bg-gradient-to-br from-brand-600 to-brand-800 rounded-xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-brand-200">
                            <i data-lucide="graduation-cap" class="w-8 h-8"></i>
                        </div>
                        <h1 class="text-3xl font-serif font-bold text-slate-800 tracking-tight">Scholar<span class="text-brand-600">Dash</span></h1>
                        <p class="text-slate-500 mt-2 text-sm">${isLogin ? 'Welcome back, researcher.' : 'Start your academic journey.'}</p>
                    </div>
                    
                    <form onsubmit="actions.handleAuth(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5 ml-1">Email</label>
                            <input type="email" name="email" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all" placeholder="researcher@university.edu">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5 ml-1">Password</label>
                            <input type="password" name="password" required minlength="6" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all" placeholder="••••••••">
                        </div>
                        <button type="submit" id="auth-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-medium py-3 rounded-lg transition-all duration-200 shadow-md shadow-brand-200 flex justify-center items-center mt-2">
                            ${isLogin ? 'Sign In' : 'Create Account'}
                        </button>
                    </form>
                    <div class="mt-6 text-center text-sm text-slate-500">
                        <span>${isLogin ? "New here?" : "Already have an account?"}</span>
                        <button onclick="actions.toggleAuthMode()" class="text-brand-600 font-semibold hover:underline ml-1">
                            ${isLogin ? 'Create account' : 'Sign in'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function renderSidebar() {
            const widthClass = state.sidebarOpen ? 'w-64 translate-x-0' : 'w-20 translate-x-0';
            const hideText = !state.sidebarOpen ? 'hidden' : '';
            return `
            <aside class="bg-white border-r border-slate-200 flex-shrink-0 transition-all duration-300 flex flex-col z-40 h-full ${widthClass} ${state.sidebarOpen ? 'absolute md:relative' : 'hidden md:flex'} shadow-xl md:shadow-none">
                <div class="h-16 flex items-center px-4 md:px-6 border-b border-slate-100">
                    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white flex-shrink-0">
                        <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                    </div>
                    <span class="ml-3 font-serif font-bold text-slate-800 text-lg tracking-tight ${hideText}">Scholar<span class="text-brand-600">Dash</span></span>
                    <button onclick="actions.toggleSidebar()" class="md:hidden ml-auto text-slate-400"><i data-lucide="x"></i></button>
                </div>

                <div class="p-4 space-y-1 flex-1 overflow-y-auto">
                    <button onclick="actions.setView('dashboard')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group ${state.view === 'dashboard' ? 'bg-brand-50 text-brand-700' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'}">
                        <i data-lucide="layout-grid" class="w-5 h-5 group-hover:text-brand-600 transition-colors"></i>
                        <span class="font-medium text-sm ${hideText}">Dashboard</span>
                    </button>

                    <div class="mt-8 mb-3 px-3 flex justify-between items-center ${hideText}">
                        <span class="text-xs font-bold uppercase tracking-wider text-slate-400">Recent Projects</span>
                        <button onclick="actions.openModal('project')" class="text-slate-400 hover:text-brand-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>

                    ${state.projects.slice(0, 5).map(p => `
                        <button onclick="actions.setView('project-detail', {id: '${p.id}'})" 
                            class="w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors group ${state.activeProject?.id === p.id ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'}" title="${p.title}">
                            <div class="w-2 h-2 rounded-full flex-shrink-0 transition-colors ${p.status === 'Active' ? 'bg-emerald-400' : 'bg-slate-300'}"></div>
                            <span class="truncate text-sm ${hideText}">${p.title}</span>
                        </button>
                    `).join('')}
                    
                    ${state.projects.length === 0 ? `<div class="px-3 text-xs text-slate-400 italic ${hideText}">No projects yet</div>` : ''}
                </div>

                <div class="p-4 border-t border-slate-100">
                    <div class="flex items-center gap-3 px-2 mb-4 ${hideText}">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs font-bold">
                            ${state.user.email.substring(0,2).toUpperCase()}
                        </div>
                        <div class="overflow-hidden">
                            <div class="text-sm font-medium text-slate-700 truncate">${state.user.email.split('@')[0]}</div>
                            <div class="text-xs text-slate-400 truncate">Pro Scholar</div>
                        </div>
                    </div>
                    <button onclick="actions.logout()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-slate-500 hover:bg-red-50 hover:text-red-600 transition-colors group">
                        <i data-lucide="log-out" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-medium text-sm ${hideText}">Sign Out</span>
                    </button>
                </div>
            </aside>`;
        }

        function renderDashboard() {
            const activeCount = state.projects.filter(p => p.status === 'Active').length;
            
            // Filter projects by search
            const filteredProjects = state.projects.filter(p => p.title.toLowerCase().includes(state.searchQuery));

            return `
            <div class="flex-1 overflow-y-auto">
                <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-20">
                    <div class="flex items-center gap-4">
                        <button onclick="actions.toggleSidebar()" class="text-slate-500 hover:text-slate-800 md:hidden"><i data-lucide="menu"></i></button>
                        <h2 class="text-xl font-serif font-bold text-slate-800">My Dashboard</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative hidden sm:block group">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-brand-500"></i>
                            <input type="text" placeholder="Search..." oninput="actions.updateSearch(this.value)" value="${state.searchQuery}"
                                class="pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none w-64 transition-all">
                        </div>
                    </div>
                </header>

                <div class="p-6 max-w-7xl mx-auto space-y-10 fade-in">
                    
                    <!-- HERO: Quick Links -->
                    <section>
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-2xl font-serif font-bold text-slate-800">Quick Access</h3>
                                <p class="text-slate-500 text-sm mt-1">Your frequently used tools and websites.</p>
                            </div>
                            <button onclick="actions.openModal('hotlink')" class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium shadow-md shadow-brand-100 transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add New Link
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-5">
                            ${state.hotlinks.map(link => `
                                <div onclick="window.open('${link.url}', '_blank')" class="group relative h-32 ${link.color} bg-white border border-slate-200 hover:border-brand-300 rounded-2xl p-5 flex flex-col justify-between cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white via-white to-transparent opacity-60 pointer-events-none"></div>
                                    
                                    <div class="flex justify-between items-start relative z-10">
                                        <div class="p-2 bg-white/80 backdrop-blur-sm rounded-lg text-slate-700 shadow-sm border border-slate-100">
                                             <img src="https://www.google.com/s2/favicons?domain=${new URL(link.url).hostname}&sz=64" 
                                                  class="w-5 h-5 object-contain opacity-80" 
                                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                             <i data-lucide="external-link" class="w-5 h-5 hidden"></i>
                                        </div>
                                        <button onclick="actions.deleteHotlink('${link.id}', event)" class="p-1.5 text-slate-400 hover:bg-red-50 hover:text-red-500 rounded-md transition-all opacity-0 group-hover:opacity-100" title="Remove Link">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="relative z-10">
                                        <h4 class="font-bold text-slate-800 leading-tight truncate text-sm md:text-base" title="${link.title}">${link.title}</h4>
                                        <div class="flex items-center gap-1 mt-1 opacity-60 group-hover:opacity-100 transition-opacity">
                                            <i data-lucide="globe" class="w-3 h-3 text-brand-600"></i>
                                            <p class="text-xs text-slate-500 truncate">${getDomain(link.url)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <button onclick="actions.openModal('hotlink')" class="h-32 border-2 border-dashed border-slate-200 hover:border-brand-300 hover:bg-brand-50/50 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:text-brand-600 transition-all gap-2 group">
                                <div class="w-10 h-10 rounded-full bg-slate-50 group-hover:bg-brand-100 flex items-center justify-center transition-colors">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </div>
                                <span class="text-xs font-bold uppercase tracking-wider">Add Link</span>
                            </button>
                        </div>
                    </section>

                    <hr class="border-slate-200">

                    <!-- SECTION: Overview Stats (Secondary) -->
                    <section>
                         <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">At a Glance</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center">
                                    <i data-lucide="folder-open"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-slate-800">${state.projects.length}</div>
                                    <div class="text-xs text-slate-500 uppercase font-semibold">Total Projects</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                    <i data-lucide="activity"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-slate-800">${activeCount}</div>
                                    <div class="text-xs text-slate-500 uppercase font-semibold">Active Studies</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-200">

                    <!-- SECTION: Projects (Tertiary) -->
                    <section>
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">Research Projects</h3>
                            </div>
                            <button onclick="actions.openModal('project')" class="text-sm text-slate-500 hover:text-brand-600 font-medium flex items-center gap-2">
                                View All <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        ${filteredProjects.length === 0 ? `
                            <div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                                <div class="w-16 h-16 bg-slate-50 text-slate-300 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="folder" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-slate-900 font-medium">No projects started</h3>
                                <p class="text-slate-500 text-sm mt-1">Create your first research project below.</p>
                                <button onclick="actions.openModal('project')" class="mt-4 text-brand-600 hover:text-brand-700 text-sm font-medium">Create Project</button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${filteredProjects.map(p => `
                                    <div onclick="actions.setView('project-detail', {id: '${p.id}'})" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer group flex flex-col h-full relative overflow-hidden">
                                        <div class="absolute top-0 left-0 w-1 h-full ${p.status === 'Active' ? 'bg-emerald-400' : p.status === 'Planning' ? 'bg-blue-400' : 'bg-slate-300'}"></div>
                                        <div class="flex justify-between items-start mb-4 pl-3">
                                            <div class="flex gap-2">
                                                <span class="px-2.5 py-1 rounded-md text-xs font-bold border ${getStatusColor(p.status)}">${p.status}</span>
                                                ${p.priority && p.priority !== 'Low' ? getPriorityBadge(p.priority) : ''}
                                            </div>
                                            <span class="text-slate-300 group-hover:text-brand-500 transition-colors"><i data-lucide="arrow-right" class="w-5 h-5"></i></span>
                                        </div>
                                        <h3 class="font-bold text-lg text-slate-800 mb-2 pl-3 line-clamp-1">${p.title}</h3>
                                        <p class="text-slate-500 text-sm line-clamp-2 mb-4 pl-3 flex-1">${p.description || 'No description provided.'}</p>
                                        
                                        <div class="mt-auto pt-4 border-t border-slate-50 flex justify-between items-center pl-3 text-xs text-slate-400">
                                            <div class="flex gap-3">
                                                <span class="flex items-center gap-1"><i data-lucide="check-square" class="w-3 h-3"></i> ${p.tasks ? p.tasks.filter(t => t.completed).length : 0}/${p.tasks ? p.tasks.length : 0}</span>
                                            </div>
                                            <span class="${p.dueDate ? 'text-brand-600 font-medium' : ''}">${p.dueDate ? `Due ${formatDate(p.dueDate)}` : ''}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </section>
                </div>
            </div>`;
        }

        function renderProjectDetail() {
            const p = state.activeProject;
            if(!p) return `<div class="p-8 text-center text-slate-400">Project not found</div>`;

            const completion = p.tasks && p.tasks.length > 0 ? Math.round((p.tasks.filter(t => t.completed).length / p.tasks.length) * 100) : 0;

            const tabs = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Overview' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'notes', icon: 'book-open', label: 'Notes' },
                { id: 'resources', icon: 'link', label: 'Resources' },
                { id: 'files', icon: 'folder', label: 'Files' }
            ];

            return `
            <div class="flex flex-col h-full bg-white fade-in">
                <!-- Project Header -->
                <div class="bg-white border-b border-slate-200 px-6 py-5">
                    <div class="max-w-5xl mx-auto w-full">
                        <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
                            <div>
                                <button onclick="actions.setView('dashboard')" class="text-xs font-bold text-slate-400 hover:text-brand-600 uppercase tracking-wider mb-2 flex items-center gap-1 transition-colors">
                                    <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to Dashboard
                                </button>
                                <h1 class="text-2xl md:text-3xl font-serif font-bold text-slate-900 mb-2">${p.title}</h1>
                                <div class="flex items-center gap-3 text-sm">
                                    <div class="relative group">
                                        <select onchange="actions.updateProject('status', this.value)" class="appearance-none pl-3 pr-8 py-1 rounded-md text-xs font-bold cursor-pointer border outline-none ring-0 ${getStatusColor(p.status)}">
                                            <option value="Active" ${p.status === 'Active' ? 'selected' : ''}>Active</option>
                                            <option value="Planning" ${p.status === 'Planning' ? 'selected' : ''}>Planning</option>
                                            <option value="Completed" ${p.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                            <option value="On Hold" ${p.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="w-3 h-3 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>
                                    </div>
                                    <span class="text-slate-400">•</span>
                                    <span class="text-slate-500">Created ${formatDate(p.createdAt?.toDate())}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="actions.deleteProject('${p.id}')" class="text-slate-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Delete Project">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar (Visible if tasks exist) -->
                        ${p.tasks && p.tasks.length > 0 ? `
                        <div class="mt-6 flex items-center gap-3">
                            <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-brand-500 rounded-full transition-all duration-500" style="width: ${completion}%"></div>
                            </div>
                            <span class="text-xs font-bold text-brand-700 w-10 text-right">${completion}%</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Tabs -->
                <div class="border-b border-slate-200 bg-slate-50/50 sticky top-0 z-10 px-6 backdrop-blur-sm">
                    <div class="max-w-5xl mx-auto flex gap-1 overflow-x-auto no-scrollbar">
                        ${tabs.map(t => `
                            <button onclick="actions.setSubTab('${t.id}')" 
                                class="px-4 py-3 text-sm font-medium border-b-2 transition-all flex items-center gap-2 whitespace-nowrap
                                ${state.projectSubTab === t.id ? 'border-brand-600 text-brand-700 bg-brand-50/50' : 'border-transparent text-slate-500 hover:text-slate-800 hover:bg-slate-100'}">
                                <i data-lucide="${t.icon}" class="w-4 h-4"></i>
                                ${t.label}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
                    <div class="max-w-5xl mx-auto min-h-full">
                        ${getTabContent(p)}
                    </div>
                </div>
            </div>`;
        }

        function getTabContent(p) {
            switch(state.projectSubTab) {
                case 'overview':
                    return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in slide-in-from-bottom-2 duration-300">
                        <div class="md:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">About this project</h3>
                                <textarea onchange="actions.updateProject('description', this.value)" 
                                    class="w-full text-slate-700 leading-relaxed min-h-[150px] bg-transparent border-none focus:ring-0 p-0 resize-none placeholder:text-slate-300" 
                                    placeholder="Add a detailed description of your research goals...">${p.description || ''}</textarea>
                            </div>
                            
                            <!-- Recent Activity / Tasks Preview -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Pending Tasks</h3>
                                    <button onclick="actions.setSubTab('tasks')" class="text-xs text-brand-600 font-medium hover:underline">View All</button>
                                </div>
                                ${!p.tasks || p.tasks.filter(t => !t.completed).length === 0 ? 
                                    `<p class="text-slate-400 text-sm italic">No pending tasks. Great job!</p>` : 
                                    `<ul class="space-y-2">
                                        ${p.tasks.filter(t => !t.completed).slice(0,3).map(t => `
                                            <li class="flex items-start gap-3 text-sm text-slate-700">
                                                <div class="w-1.5 h-1.5 rounded-full bg-brand-400 mt-2 flex-shrink-0"></div>
                                                <span class="line-clamp-1">${t.text}</span>
                                            </li>
                                        `).join('')}
                                    </ul>`
                                }
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Details</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs text-slate-500 font-semibold">Priority</label>
                                        <select onchange="actions.updateProject('priority', this.value)" class="w-full mt-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:border-brand-500 outline-none">
                                            <option value="Low" ${p.priority === 'Low' ? 'selected' : ''}>Low</option>
                                            <option value="Medium" ${p.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                            <option value="High" ${p.priority === 'High' ? 'selected' : ''}>High</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500 font-semibold">Due Date</label>
                                        <input type="date" value="${p.dueDate || ''}" onchange="actions.updateProject('dueDate', this.value)" class="w-full mt-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:border-brand-500 outline-none">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                case 'tasks':
                    return `
                    <div class="max-w-3xl mx-auto animate-in slide-in-from-bottom-2 duration-300">
                        <form onsubmit="actions.addTask(event)" class="mb-6 relative">
                            <input type="text" name="task" placeholder="Add a new task..." class="w-full pl-4 pr-12 py-3 bg-white border border-slate-200 rounded-xl shadow-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none">
                            <button type="submit" class="absolute right-2 top-1.5 p-1.5 bg-slate-100 text-slate-500 rounded-lg hover:bg-brand-600 hover:text-white transition-colors">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </form>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            ${!p.tasks || p.tasks.length === 0 ? 
                                `<div class="p-12 text-center text-slate-400">
                                    <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                                    <p>No tasks yet. Break your research down into steps!</p>
                                </div>` : 
                                `<ul class="divide-y divide-slate-100">
                                    ${p.tasks.map(t => `
                                        <li class="group flex items-center gap-3 p-4 hover:bg-slate-50 transition-colors">
                                            <button onclick="actions.toggleTask('${t.id}')" class="flex-shrink-0 w-5 h-5 rounded border ${t.completed ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300 text-transparent hover:border-brand-500'} flex items-center justify-center transition-all">
                                                <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                            </button>
                                            <span class="flex-1 text-sm ${t.completed ? 'text-slate-400 line-through' : 'text-slate-700'}">${t.text}</span>
                                            <button onclick="actions.deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>`
                            }
                        </div>
                    </div>`;

                case 'notes':
                    return `
                    <div class="max-w-4xl mx-auto h-full flex flex-col animate-in slide-in-from-bottom-2 duration-300">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[calc(100vh-250px)]">
                            <div class="border-b border-slate-100 px-4 py-2 flex items-center justify-between bg-slate-50/50 rounded-t-xl">
                                <span class="text-xs font-bold text-slate-400 uppercase">Research Log</span>
                                <button id="save-notes-btn" onclick="actions.saveNotes()" class="text-xs bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded-md transition-all shadow-sm">
                                    Save Notes
                                </button>
                            </div>
                            <textarea id="project-notes" class="flex-1 w-full p-6 resize-none outline-none text-slate-700 leading-7 font-serif text-lg placeholder:text-slate-300 rounded-b-xl" 
                                placeholder="Start typing your research notes, hypotheses, or ideas here...">${p.notes || ''}</textarea>
                        </div>
                        <p class="text-center text-xs text-slate-400 mt-2">Notes are simple text for now. Markdown support coming soon.</p>
                    </div>`;

                case 'resources':
                    return `
                    <div class="max-w-4xl mx-auto animate-in slide-in-from-bottom-2 duration-300">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">External Resources</h3>
                                <p class="text-sm text-slate-500">Keep track of your citations and reading material.</p>
                            </div>
                            <button onclick="actions.openModal('resource')" class="bg-white border border-slate-200 hover:border-brand-300 hover:text-brand-600 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-all flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Resource
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${(!p.resources || p.resources.length === 0) ? 
                                `<div class="bg-white p-8 rounded-xl border border-dashed border-slate-300 text-center text-slate-400">
                                    <i data-lucide="book" class="w-10 h-10 mx-auto mb-2 opacity-20"></i>
                                    No resources added yet.
                                </div>` : 
                                p.resources.map(r => `
                                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all flex justify-between items-center group">
                                    <div class="flex items-center gap-4 overflow-hidden">
                                        <div class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center flex-shrink-0">
                                            <i data-lucide="globe" class="w-5 h-5"></i>
                                        </div>
                                        <div class="truncate">
                                            <h4 class="font-medium text-slate-800 truncate">${r.title}</h4>
                                            <a href="${r.url}" target="_blank" class="text-xs text-brand-600 hover:underline flex items-center gap-1 truncate">
                                                ${new URL(r.url).hostname} <i data-lucide="external-link" class="w-3 h-3"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <button onclick="actions.deleteResource('${r.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;

                case 'files':
                    return `
                    <div class="max-w-4xl mx-auto animate-in slide-in-from-bottom-2 duration-300">
                         <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Files & Documents</h3>
                                <p class="text-sm text-slate-500">PDFs, Datasets, Images.</p>
                            </div>
                            <button onclick="actions.openModal('file')" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-all flex items-center gap-2">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload File
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
                                    <tr>
                                        <th class="px-6 py-4">Name</th>
                                        <th class="px-6 py-4">Size</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${state.activeProjectFiles.length === 0 ? 
                                        `<tr><td colspan="3" class="px-6 py-12 text-center text-slate-400 italic">No files uploaded.</td></tr>` : 
                                        state.activeProjectFiles.map(f => `
                                        <tr class="hover:bg-slate-50 group transition-colors">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-8 h-8 rounded bg-slate-100 text-slate-500 flex items-center justify-center">
                                                        <i data-lucide="file" class="w-4 h-4"></i>
                                                    </div>
                                                    <span class="font-medium text-slate-700">${f.name}</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-slate-500">${formatSize(f.size)}</td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <a href="${f.url}" target="_blank" download class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg"><i data-lucide="download" class="w-4 h-4"></i></a>
                                                    <button onclick="actions.deleteFile('${f.id}', '${f.storagePath || ''}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
        }

        // --- Modal Content Factory ---
        function getModalContent(type) {
            const wrapper = (title, content) => `
                <div class="flex flex-col max-h-[80vh]">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/80">
                        <h3 class="font-bold text-slate-800">${title}</h3>
                        <button onclick="actions.closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    ${content}
                </div>
            `;

            if (type === 'project') {
                return wrapper('Create New Project', `
                    <form onsubmit="actions.addProject(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Project Title</label>
                            <input name="title" required class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all" placeholder="e.g., Thesis Research">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                            <textarea name="description" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none h-24 resize-none transition-all" placeholder="What is this project about?"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Priority</label>
                                <select name="priority" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none">
                                    <option>Low</option>
                                    <option>Medium</option>
                                    <option>High</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Due Date</label>
                                <input type="date" name="dueDate" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none text-slate-600">
                            </div>
                        </div>
                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" onclick="actions.closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium shadow-sm">Create Project</button>
                        </div>
                    </form>
                `);
            }
            if (type === 'hotlink') {
                return wrapper('Add Quick Link', `
                    <form onsubmit="actions.addHotlink(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                            <input name="title" required class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none" placeholder="e.g. University Library">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL</label>
                            <input name="url" type="url" required class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none" placeholder="https://...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Color Tag</label>
                            <div class="flex gap-3">
                                <label class="cursor-pointer"><input type="radio" name="color" value="bg-white border-slate-200" checked class="peer sr-only"><div class="w-8 h-8 rounded-full bg-white border border-slate-300 peer-checked:ring-2 peer-checked:ring-brand-500 peer-checked:scale-110 transition-all"></div></label>
                                <label class="cursor-pointer"><input type="radio" name="color" value="bg-red-50 border-red-200" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-red-50 border border-red-200 peer-checked:ring-2 peer-checked:ring-red-500 peer-checked:scale-110 transition-all"></div></label>
                                <label class="cursor-pointer"><input type="radio" name="color" value="bg-emerald-50 border-emerald-200" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-emerald-50 border border-emerald-200 peer-checked:ring-2 peer-checked:ring-emerald-500 peer-checked:scale-110 transition-all"></div></label>
                                <label class="cursor-pointer"><input type="radio" name="color" value="bg-blue-50 border-blue-200" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 peer-checked:ring-2 peer-checked:ring-blue-500 peer-checked:scale-110 transition-all"></div></label>
                                <label class="cursor-pointer"><input type="radio" name="color" value="bg-purple-50 border-purple-200" class="peer sr-only"><div class="w-8 h-8 rounded-full bg-purple-50 border border-purple-200 peer-checked:ring-2 peer-checked:ring-purple-500 peer-checked:scale-110 transition-all"></div></label>
                            </div>
                        </div>
                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" onclick="actions.closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium shadow-sm">Add Link</button>
                        </div>
                    </form>
                `);
            }
            if (type === 'resource') {
                return wrapper('Add Resource', `
                    <form onsubmit="actions.addResource(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                            <input name="title" required class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none" placeholder="Article Title">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL</label>
                            <input name="url" type="url" required class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg focus:border-brand-500 outline-none" placeholder="https://doi.org/...">
                        </div>
                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" onclick="actions.closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium shadow-sm">Add Resource</button>
                        </div>
                    </form>
                `);
            }
            if (type === 'file') {
                return wrapper('Upload File', `
                    <div id="upload-area" class="p-6">
                        <div onclick="actions.triggerFileUpload()" class="border-2 border-dashed border-slate-300 rounded-xl p-8 cursor-pointer hover:bg-brand-50 hover:border-brand-300 transition-all group text-center">
                            <div class="w-12 h-12 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-brand-100 group-hover:text-brand-600 transition-colors">
                                <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                            </div>
                            <p class="text-slate-700 font-medium mb-1">Click to browse</p>
                            <p class="text-xs text-slate-400">PDF, DOCX, JPG, PNG supported</p>
                            <input type="file" id="file-upload-input" class="hidden" onchange="actions.handleFileUpload(this)">
                        </div>
                    </div>
                `);
            }
        }
    </script>
</body>
</html>
