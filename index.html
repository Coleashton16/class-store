<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans overflow-hidden h-screen flex">

    <!-- App Root -->
    <div id="app" class="flex w-full h-full">
        <!-- Loading State -->
        <div class="m-auto flex flex-col items-center gap-4 text-slate-400">
            <div class="w-8 h-8 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"></div>
            <p>Initializing Scholar Workspace...</p>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- Dynamic Modal Content Injected Here -->
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 border border-slate-200"></div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, serverTimestamp, query, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUihvWOpQv6CtpP0DzoGxO9Bi77gFVLdc",
            authDomain: "class-store-d5966.firebaseapp.com",
            projectId: "class-store-d5966",
            storageBucket: "class-store-d5966.firebasestorage.app",
            messagingSenderId: "697447403447",
            appId: "1:697447403447:web:cd7f70935a3e16a2bba232"
        };

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        const state = {
            user: null,
            view: 'loading', // 'loading' | 'login' | 'dashboard' | 'project-detail'
            authMode: 'login', // 'login' | 'signup'
            sidebarOpen: true,
            activeProject: null,
            projectSubTab: 'overview',
            
            // Data
            hotlinks: [],
            projects: [],
            activeProjectFiles: [],

            // Unsubscribe functions
            unsubHotlinks: null,
            unsubProjects: null,
            unsubFiles: null
        };

        // --- Auth & Listeners ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                state.view = 'dashboard';
                setupListeners(user.uid);
            } else {
                // Clear data on logout
                if (state.unsubHotlinks) state.unsubHotlinks();
                if (state.unsubProjects) state.unsubProjects();
                if (state.unsubFiles) state.unsubFiles();
                
                state.user = null;
                state.view = 'login';
                state.projects = [];
                state.hotlinks = [];
                render();
            }
        });

        function setupListeners(uid) {
            // Hotlinks Listener
            const hotlinksRef = collection(db, 'users', uid, 'hotlinks');
            state.unsubHotlinks = onSnapshot(hotlinksRef, (snap) => {
                state.hotlinks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });

            // Projects Listener
            const projectsRef = query(collection(db, 'users', uid, 'projects'), orderBy('createdAt', 'desc'));
            state.unsubProjects = onSnapshot(projectsRef, (snap) => {
                state.projects = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Update active project reference if it exists to keep it fresh
                if (state.activeProject) {
                    const fresh = state.projects.find(p => p.id === state.activeProject.id);
                    if (fresh) state.activeProject = fresh;
                    else {
                        state.activeProject = null;
                        state.view = 'dashboard';
                    }
                }
                render();
            });
        }

        // Setup Files Listener
        function setupFileListener(projectId) {
            if (state.unsubFiles) state.unsubFiles();
            
            const filesRef = query(collection(db, 'users', state.user.uid, 'projects', projectId, 'files'), orderBy('createdAt', 'desc'));
            state.unsubFiles = onSnapshot(filesRef, (snap) => {
                state.activeProjectFiles = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
        }

        // --- Actions ---

        window.actions = {
            // Auth Actions
            toggleAuthMode: () => {
                state.authMode = state.authMode === 'login' ? 'signup' : 'login';
                render();
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const errorDiv = document.getElementById('auth-error');
                const btn = document.getElementById('auth-btn');
                
                errorDiv.classList.add('hidden');
                btn.disabled = true;
                btn.innerText = 'Processing...';

                try {
                    if (state.authMode === 'signup') {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                    // onAuthStateChanged will handle the redirect
                } catch (err) {
                    console.error(err);
                    errorDiv.textContent = formatAuthError(err.code);
                    errorDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerText = state.authMode === 'login' ? 'Sign In' : 'Create Account';
                }
            },

            logout: async () => {
                await signOut(auth);
            },

            // Navigation Actions
            toggleSidebar: () => {
                state.sidebarOpen = !state.sidebarOpen;
                render();
            },
            
            setView: (view, project = null) => {
                state.view = view;
                if (project) {
                    state.activeProject = project;
                    state.projectSubTab = 'overview';
                    setupFileListener(project.id);
                } else {
                    state.activeProject = null;
                    state.activeProjectFiles = [];
                    if (state.unsubFiles) state.unsubFiles();
                }
                render();
            },

            setSubTab: (tab) => {
                state.projectSubTab = tab;
                render();
            },

            // Modal Handlers
            openModal: (type) => {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.remove('hidden');
                content.innerHTML = getModalContent(type);
            },

            closeModal: () => {
                document.getElementById('modal-overlay').classList.add('hidden');
            },

            // Data Operations
            addHotlink: async (e) => {
                e.preventDefault();
                // Get selected color
                const colorInputs = document.getElementsByName('color');
                let selectedColor = 'bg-white border-slate-200';
                for(let input of colorInputs) {
                    if(input.checked) selectedColor = input.value;
                }

                await addDoc(collection(db, 'users', state.user.uid, 'hotlinks'), {
                    title: e.target.title.value, 
                    url: e.target.url.value, 
                    color: selectedColor,
                    createdAt: serverTimestamp()
                });
                window.actions.closeModal();
            },

            deleteHotlink: async (id) => {
                if(confirm('Remove this shortcut?')) await deleteDoc(doc(db, 'users', state.user.uid, 'hotlinks', id));
            },

            addProject: async (e) => {
                e.preventDefault();
                const form = e.target;
                const newProj = {
                    title: form.title.value, description: form.description.value, status: form.status.value, resources: [], createdAt: serverTimestamp()
                };
                const ref = await addDoc(collection(db, 'users', state.user.uid, 'projects'), newProj);
                window.actions.closeModal();
                window.actions.setView('project-detail', {id: ref.id, ...newProj});
            },

            updateProjectStatus: async (projectId, newStatus) => {
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', projectId), {
                    status: newStatus
                });
            },

            deleteProject: async (id) => {
                if(confirm('Delete project and all data?')) await deleteDoc(doc(db, 'users', state.user.uid, 'projects', id));
            },

            addResource: async (e) => {
                e.preventDefault();
                const newResource = { id: crypto.randomUUID(), title: e.target.title.value, url: e.target.url.value, createdAt: new Date().toISOString() };
                const updatedResources = [...(state.activeProject.resources || []), newResource];
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
                window.actions.closeModal();
            },

            deleteResource: async (resId) => {
                const updatedResources = state.activeProject.resources.filter(r => r.id !== resId);
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
            },

            triggerFileUpload: () => document.getElementById('file-upload-input').click(),

            handleFileUpload: (input) => {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) { alert('File too large. Max 1MB allowed.'); return; }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await addDoc(collection(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files'), {
                        name: file.name, type: file.type, size: file.size, data: e.target.result, createdAt: serverTimestamp()
                    });
                    window.actions.closeModal();
                };
                reader.readAsDataURL(file);
            },

            deleteFile: async (fileId) => {
                if(confirm('Delete file permanently?')) await deleteDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files', fileId));
            },

            downloadFile: (data, name) => {
                const link = document.createElement('a');
                link.href = data; link.download = name;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        };

        function formatAuthError(code) {
            switch(code) {
                case 'auth/invalid-email': return 'Invalid email address.';
                case 'auth/user-disabled': return 'This user account has been disabled.';
                case 'auth/user-not-found': return 'No account found with this email.';
                case 'auth/wrong-password': return 'Incorrect password.';
                case 'auth/email-already-in-use': return 'Email is already registered.';
                case 'auth/weak-password': return 'Password must be at least 6 characters.';
                default: return 'Authentication failed. Please try again.';
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Active': return 'bg-green-100 text-green-700';
                case 'Planning': return 'bg-blue-100 text-blue-700';
                case 'Completed': return 'bg-slate-200 text-slate-700';
                case 'On Hold': return 'bg-amber-100 text-amber-700';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        // --- DOM Rendering ---

        function render() {
            const app = document.getElementById('app');

            if (state.view === 'loading') return; // Keep loading spinner

            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderSidebar()}
                    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <div class="flex-1 overflow-y-auto">
                            ${state.view === 'dashboard' ? renderDashboard() : renderProjectDetail()}
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `
            <div class="min-h-screen w-full flex items-center justify-center bg-slate-100 p-4 fade-in">
                <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-slate-200">
                    <div class="text-center mb-8">
                        <div class="w-12 h-12 bg-teal-600 rounded-lg flex items-center justify-center text-white mx-auto mb-4">
                            <i data-lucide="layout" class="w-6 h-6"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-slate-800">Scholar<span class="text-teal-600">Dash</span></h1>
                        <p class="text-slate-500 mt-2">${isLogin ? 'Sign in to manage your research.' : 'Create your research workspace.'}</p>
                    </div>
                    
                    <form onsubmit="actions.handleAuth(event)" class="space-y-4">
                        <div id="auth-error" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-md border border-red-200"></div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                            <input type="email" name="email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all" placeholder="you@example.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                            <input type="password" name="password" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all" placeholder="••••••••">
                        </div>

                        <button type="submit" id="auth-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2.5 rounded-lg transition-all duration-200 shadow-sm mt-2">
                            ${isLogin ? 'Sign In' : 'Create Account'}
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-slate-500">
                        <span>${isLogin ? "Don't have an account?" : "Already have an account?"}</span>
                        <button onclick="actions.toggleAuthMode()" class="text-teal-600 font-semibold hover:underline ml-1">
                            ${isLogin ? 'Create one' : 'Sign in'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function renderSidebar() {
            const widthClass = state.sidebarOpen ? 'w-64' : 'w-16';
            const hideText = !state.sidebarOpen ? 'hidden' : '';
            
            return `
            <div class="bg-slate-900 text-slate-300 flex-shrink-0 transition-all duration-300 flex flex-col ${widthClass}">
                <div class="h-16 flex items-center px-4 border-b border-slate-800">
                    <div class="w-8 h-8 bg-teal-600 rounded flex items-center justify-center text-white flex-shrink-0">
                        <i data-lucide="layout"></i>
                    </div>
                    <span class="ml-3 font-bold text-white tracking-tight ${hideText}">Scholar<span class="text-teal-500">Dash</span></span>
                </div>

                <div class="p-3 space-y-1 flex-1 overflow-y-auto">
                    <button onclick="actions.setView('dashboard')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md transition-colors ${state.view === 'dashboard' ? 'bg-slate-800 text-white' : 'hover:bg-slate-800 hover:text-white'}">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        <span class="${hideText}">Dashboard</span>
                    </button>

                    <div class="mt-8 mb-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-500 ${hideText}">
                        Recent Projects
                    </div>
                    
                    ${state.projects.slice(0, 5).map(p => `
                        <button onclick="actions.setView('project-detail', ${JSON.stringify(p).replace(/"/g, '&quot;')})" 
                            class="w-full flex items-center gap-3 px-3 py-2 rounded-md transition-colors ${state.activeProject?.id === p.id ? 'bg-teal-900/50 text-teal-400' : 'hover:bg-slate-800 hover:text-white'}" title="${p.title}">
                            <div class="w-2 h-2 rounded-full flex-shrink-0 ${p.status === 'Active' ? 'bg-green-500' : 'bg-slate-600'}"></div>
                            <span class="truncate text-sm ${hideText}">${p.title}</span>
                        </button>
                    `).join('')}
                </div>

                <div class="p-3 border-t border-slate-800">
                    <button onclick="actions.logout()" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-red-400 hover:bg-slate-800 hover:text-red-300 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span class="${hideText}">Sign Out</span>
                    </button>
                </div>

                <div class="p-4 border-t border-slate-800">
                    <button onclick="actions.toggleSidebar()" class="flex items-center gap-3 text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                        <span class="text-sm ${hideText}">Collapse</span>
                    </button>
                </div>
            </div>`;
        }

        function renderDashboard() {
            const activeCount = state.projects.filter(p => p.status === 'Active').length;
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            return `
            <div class="max-w-5xl mx-auto p-8 space-y-8 fade-in">
                <header class="flex justify-between items-end pb-6 border-b border-slate-200">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Research Overview</h1>
                        <p class="text-slate-500 mt-1">Manage your active studies and resources.</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-slate-500 block">${dateStr}</span>
                        <span class="text-xs text-slate-400 block mt-1">${state.user.email}</span>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center"><i data-lucide="folder"></i></div>
                        <div><div class="text-2xl font-bold text-slate-800">${state.projects.length}</div><div class="text-sm text-slate-500">Total Projects</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i data-lucide="activity"></i></div>
                        <div><div class="text-2xl font-bold text-slate-800">${activeCount}</div><div class="text-sm text-slate-500">Active Studies</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center"><i data-lucide="link"></i></div>
                        <div><div class="text-2xl font-bold text-slate-800">${state.hotlinks.length}</div><div class="text-sm text-slate-500">Quick Links</div></div>
                    </div>
                </div>

                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800">Quick Access</h2>
                        <button onclick="actions.openModal('hotlink')" class="text-xs flex items-center gap-1 hover:bg-slate-100 px-2 py-1 rounded text-slate-600">
                            <i data-lucide="plus" class="w-3 h-3"></i> Add Link
                        </button>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        ${state.hotlinks.map(link => `
                            <div class="group relative ${link.color || 'bg-white border-slate-200'} border hover:border-teal-400 p-4 rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer flex flex-col items-center text-center">
                                <button onclick="actions.deleteHotlink('${link.id}')" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                                <a href="${link.url}" target="_blank" class="flex flex-col items-center w-full">
                                    <div class="w-10 h-10 mb-3 rounded-full bg-white/60 flex items-center justify-center text-slate-600 group-hover:bg-white group-hover:text-teal-600 transition-colors shadow-sm">
                                        <i data-lucide="external-link" class="w-4 h-4"></i>
                                    </div>
                                    <span class="font-medium text-slate-700 text-sm truncate w-full">${link.title}</span>
                                </a>
                            </div>
                        `).join('')}
                        <button onclick="actions.openModal('hotlink')" class="border border-dashed border-slate-300 rounded-lg p-4 flex flex-col items-center justify-center text-slate-400 hover:text-teal-600 hover:border-teal-400 hover:bg-teal-50/50 transition-all min-h-[120px]">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                            <span class="text-xs font-medium mt-2">Add New</span>
                        </button>
                    </div>
                </section>

                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800">All Projects</h2>
                        <button onclick="actions.openModal('project')" class="text-sm flex items-center gap-2 bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i> New Project
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.projects.map(p => `
                            <div onclick="actions.setView('project-detail', ${JSON.stringify(p).replace(/"/g, '&quot;')})" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 hover:shadow-md hover:border-teal-300 transition-all cursor-pointer group">
                                <div class="flex justify-between items-start mb-4">
                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(p.status)}">${p.status}</span>
                                    <span class="text-slate-400 group-hover:text-teal-500 transition-colors"><i data-lucide="chevron-right"></i></span>
                                </div>
                                <h3 class="font-bold text-lg text-slate-800 mb-2">${p.title}</h3>
                                <p class="text-slate-500 text-sm line-clamp-2 mb-4 h-10">${p.description || ''}</p>
                                <div class="flex gap-4 text-xs text-slate-400 pt-4 border-t border-slate-100">
                                    <span class="flex items-center gap-1"><i data-lucide="link" class="w-3 h-3"></i> ${p.resources ? p.resources.length : 0} Links</span>
                                    <span>•</span>
                                    <span>Created ${p.createdAt?.seconds ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            </div>`;
        }

        function renderProjectDetail() {
            const p = state.activeProject;
            
            const renderOverview = () => `
                <div class="max-w-3xl">
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Description</h3>
                        <p class="text-slate-600 leading-relaxed whitespace-pre-wrap">${p.description || "No description provided."}</p>
                    </div>
                </div>`;

            const renderResources = () => `
                <div class="max-w-4xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-slate-800">Linked Resources</h3>
                        <button onclick="actions.openModal('resource')" class="flex items-center gap-2 text-sm bg-teal-700 text-white px-3 py-1.5 rounded-md hover:bg-teal-800"><i data-lucide="plus" class="w-4 h-4"></i> Add Resource</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3 font-semibold text-slate-600">Title</th>
                                    <th class="px-6 py-3 font-semibold text-slate-600">Source</th>
                                    <th class="px-6 py-3 font-semibold text-slate-600 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${(!p.resources || p.resources.length === 0) ? `<tr><td colspan="3" class="px-6 py-8 text-center text-slate-400">No resources linked yet.</td></tr>` : ''}
                                ${(p.resources || []).map(r => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-4 font-medium text-slate-800">${r.title}</td>
                                        <td class="px-6 py-4"><a href="${r.url}" target="_blank" class="text-teal-600 hover:underline flex items-center gap-1">${new URL(r.url).hostname} <i data-lucide="external-link" class="w-3 h-3"></i></a></td>
                                        <td class="px-6 py-4 text-right"><button onclick="actions.deleteResource('${r.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            const renderFiles = () => `
                <div class="max-w-4xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-slate-800">Project Files</h3>
                        <button onclick="actions.openModal('file')" class="flex items-center gap-2 text-sm bg-teal-700 text-white px-3 py-1.5 rounded-md hover:bg-teal-800"><i data-lucide="upload" class="w-4 h-4"></i> Upload File</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3 font-semibold text-slate-600">Name</th>
                                    <th class="px-6 py-3 font-semibold text-slate-600">Size</th>
                                    <th class="px-6 py-3 font-semibold text-slate-600 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${(state.activeProjectFiles.length === 0) ? `<tr><td colspan="3" class="px-6 py-12 text-center text-slate-400">No files uploaded yet.</td></tr>` : ''}
                                ${state.activeProjectFiles.map(f => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-4 font-medium text-slate-800 flex items-center gap-2"><i data-lucide="file" class="w-4 h-4 text-slate-400"></i> ${f.name}</td>
                                        <td class="px-6 py-4 text-slate-500">${(f.size/1024).toFixed(1)} KB</td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="flex justify-end gap-3">
                                                <button onclick="actions.downloadFile('${f.data}', '${f.name}')" class="text-slate-400 hover:text-teal-600"><i data-lucide="download" class="w-4 h-4"></i></button>
                                                <button onclick="actions.deleteFile('${f.id}')" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            const getSubContent = () => {
                if (state.projectSubTab === 'resources') return renderResources();
                if (state.projectSubTab === 'files') return renderFiles();
                return renderOverview();
            };

            return `
            <div class="flex flex-col h-full fade-in">
                <div class="bg-white border-b border-slate-200 px-8 py-6 flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2 text-sm text-slate-500 mb-2">
                            <span onclick="actions.setView('dashboard')" class="hover:text-teal-600 cursor-pointer">Projects</span>
                            <i data-lucide="chevron-right" class="w-3 h-3"></i>
                            <span class="text-slate-800 font-medium">${p.title}</span>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-900 mb-2">${p.title}</h1>
                        <div class="flex gap-2 items-center">
                            <span class="text-xs text-slate-500 uppercase font-bold tracking-wider mr-2">Status:</span>
                            <select onchange="actions.updateProjectStatus('${p.id}', this.value)" class="text-xs font-bold rounded-full px-3 py-1 cursor-pointer outline-none border-none ring-0 ${getStatusColor(p.status)}">
                                <option value="Active" ${p.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Planning" ${p.status === 'Planning' ? 'selected' : ''}>Planning</option>
                                <option value="Completed" ${p.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="On Hold" ${p.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="actions.deleteProject('${p.id}')" class="text-sm text-red-600 hover:text-red-800 px-3 py-1.5 border border-red-200 rounded hover:bg-red-50">Delete Project</button>
                </div>
                
                <div class="bg-white border-b border-slate-200 px-8 flex gap-6">
                    ${['overview', 'resources', 'files'].map(t => `
                        <button onclick="actions.setSubTab('${t}')" class="py-4 text-sm font-medium border-b-2 transition-colors capitalize ${state.projectSubTab === t ? 'border-teal-600 text-teal-700' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                            ${t}
                        </button>
                    `).join('')}
                </div>

                <div class="flex-1 overflow-y-auto bg-slate-50 p-8">
                    ${getSubContent()}
                </div>
            </div>`;
        }

        // --- Modal Templates ---
        function getModalContent(type) {
            const header = (title) => `<div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50"><h3 class="font-semibold text-slate-800">${title}</h3><button onclick="actions.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div>`;
            const footer = (btnText) => `<div class="flex justify-end gap-2 mt-6"><button type="button" onclick="actions.closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-md text-sm">Cancel</button><button type="submit" class="px-4 py-2 bg-teal-700 text-white hover:bg-teal-800 rounded-md text-sm">${btnText}</button></div>`;

            if (type === 'hotlink') {
                return `
                <form onsubmit="actions.addHotlink(event)">
                    ${header('Add Quick Link')}
                    <div class="p-6">
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Title</label><input name="title" required class="w-full px-3 py-2 border rounded-md" placeholder="e.g. PubMed"></div>
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">URL</label><input name="url" required class="w-full px-3 py-2 border rounded-md" placeholder="https://..."></div>
                        
                        <div class="mb-4">
                            <label class="block text-xs font-semibold uppercase text-slate-500 mb-2">Color Appearance</label>
                            <div class="flex gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-white border-slate-200" checked class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-white border border-slate-300 peer-checked:ring-2 peer-checked:ring-slate-400"></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-red-50 border-red-100" class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-red-50 border border-red-200 peer-checked:ring-2 peer-checked:ring-red-400"></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-orange-50 border-orange-100" class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-orange-50 border border-orange-200 peer-checked:ring-2 peer-checked:ring-orange-400"></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-green-50 border-green-100" class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-green-50 border border-green-200 peer-checked:ring-2 peer-checked:ring-green-400"></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-blue-50 border-blue-100" class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 peer-checked:ring-2 peer-checked:ring-blue-400"></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="color" value="bg-purple-50 border-purple-100" class="peer sr-only">
                                    <div class="w-8 h-8 rounded-full bg-purple-50 border border-purple-200 peer-checked:ring-2 peer-checked:ring-purple-400"></div>
                                </label>
                            </div>
                        </div>

                        ${footer('Add Link')}
                    </div>
                </form>`;
            }
            if (type === 'project') {
                return `
                <form onsubmit="actions.addProject(event)">
                    ${header('Create New Project')}
                    <div class="p-6">
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Project Title</label><input name="title" required class="w-full px-3 py-2 border rounded-md"></div>
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Description</label><textarea name="description" class="w-full px-3 py-2 border rounded-md h-24"></textarea></div>
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Status</label><select name="status" class="w-full px-3 py-2 border rounded-md"><option>Active</option><option>Planning</option><option>Completed</option></select></div>
                        ${footer('Create Project')}
                    </div>
                </form>`;
            }
            if (type === 'resource') {
                return `
                <form onsubmit="actions.addResource(event)">
                    ${header('Add Resource')}
                    <div class="p-6">
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Title</label><input name="title" required class="w-full px-3 py-2 border rounded-md"></div>
                        <div class="mb-4"><label class="block text-xs font-semibold uppercase text-slate-500 mb-1">URL</label><input name="url" required class="w-full px-3 py-2 border rounded-md"></div>
                        ${footer('Add Resource')}
                    </div>
                </form>`;
            }
            if (type === 'file') {
                return `
                <div>
                    ${header('Upload File')}
                    <div class="p-6 text-center">
                        <div onclick="actions.triggerFileUpload()" class="border-2 border-dashed border-slate-300 rounded-lg p-8 mb-4 cursor-pointer hover:bg-slate-50 transition-colors">
                            <i data-lucide="upload" class="mx-auto text-slate-400 mb-4 w-12 h-12"></i>
                            <p class="text-sm text-slate-600 mb-2">Click to select file</p>
                            <p class="text-xs text-slate-400">Max 1MB (Firestore Limit)</p>
                            <input type="file" id="file-upload-input" class="hidden" onchange="actions.handleFileUpload(this)">
                        </div>
                        <button onclick="actions.closeModal()" class="text-sm text-slate-500 hover:text-slate-700">Cancel</button>
                    </div>
                </div>`;
            }
        }
    </script>
</body>
</html>
