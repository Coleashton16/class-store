<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for a cleaner, more academic look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-10px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    }
                }
            },
            safelist: [
                'bg-teal-600', 'bg-teal-50', 'text-teal-600', 'text-teal-500', 'text-teal-700', 'border-teal-200', 'border-teal-600', 'hover:bg-teal-700', 'hover:text-teal-600', 'hover:border-teal-400', 'focus:ring-teal-500',
                'bg-indigo-600', 'bg-indigo-50', 'text-indigo-600', 'text-indigo-500', 'text-indigo-700', 'border-indigo-200', 'border-indigo-600', 'hover:bg-indigo-700', 'hover:text-indigo-600', 'hover:border-indigo-400', 'focus:ring-indigo-500',
                'bg-rose-600', 'bg-rose-50', 'text-rose-600', 'text-rose-500', 'text-rose-700', 'border-rose-200', 'border-rose-600', 'hover:bg-rose-700', 'hover:text-rose-600', 'hover:border-rose-400', 'focus:ring-rose-500',
                'bg-violet-600', 'bg-violet-50', 'text-violet-600', 'text-violet-500', 'text-violet-700', 'border-violet-200', 'border-violet-600', 'hover:bg-violet-700', 'hover:text-violet-600', 'hover:border-violet-400', 'focus:ring-violet-500',
                'bg-amber-600', 'bg-amber-50', 'text-amber-600', 'text-amber-500', 'text-amber-700', 'border-amber-200', 'border-amber-600', 'hover:bg-amber-700', 'hover:text-amber-600', 'hover:border-amber-400', 'focus:ring-amber-500',
                'bg-emerald-600', 'bg-emerald-50', 'text-emerald-600', 'text-emerald-500', 'text-emerald-700', 'border-emerald-200', 'border-emerald-600', 'hover:bg-emerald-700', 'hover:text-emerald-600', 'hover:border-emerald-400', 'focus:ring-emerald-500',
            ]
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }

        .upload-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid currentColor;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Sortable Ghost State */
        .sortable-ghost {
            opacity: 0.4;
            background: #f1f5f9;
            border: 2px dashed #94a3b8;
        }
        .sortable-drag {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden h-screen flex selection:bg-slate-200 selection:text-slate-900">

    <!-- App Root -->
    <div id="app" class="flex w-full h-full">
        <!-- Loading State -->
        <div class="m-auto flex flex-col items-center gap-6 text-slate-400 animate-fade-in">
            <div class="relative">
                <div class="w-12 h-12 border-4 border-slate-200 border-t-slate-800 rounded-full animate-spin"></div>
            </div>
            <p class="text-sm font-medium tracking-wide uppercase opacity-70">Initializing Workspace</p>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <!-- Dynamic Modal Content Injected Here -->
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in border border-white/20 ring-1 ring-black/5"></div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, serverTimestamp, query, orderBy, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUihvWOpQv6CtpP0DzoGxO9Bi77gFVLdc",
            authDomain: "class-store-d5966.firebaseapp.com",
            projectId: "class-store-d5966",
            storageBucket: "class-store-d5966.firebasestorage.app",
            messagingSenderId: "697447403447",
            appId: "1:697447403447:web:cd7f70935a3e16a2bba232"
        };

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Management ---
        const state = {
            user: null,
            view: 'loading', // 'loading' | 'login' | 'dashboard' | 'project-detail'
            authMode: 'login', // 'login' | 'signup'
            sidebarOpen: true,
            activeProject: null,
            projectSubTab: 'overview',
            isUploading: false,
            
            // Customization
            theme: localStorage.getItem('scholar_theme') || 'teal', // teal, indigo, rose, violet, amber

            // Data
            hotlinks: [],
            projects: [],
            activeProjectFiles: [],

            // Unsubscribe functions
            unsubHotlinks: null,
            unsubProjects: null,
            unsubFiles: null
        };

        // --- Helpers for Dynamic Classes ---
        // These maps allow us to dynamically switch themes while keeping Tailwind classes valid
        const getThemeClasses = (type) => {
            const t = state.theme;
            const maps = {
                text: `text-${t}-600`,
                textLight: `text-${t}-500`,
                textDark: `text-${t}-700`,
                bg: `bg-${t}-600`,
                bgLight: `bg-${t}-50`,
                bgHover: `hover:bg-${t}-700`,
                textHover: `hover:text-${t}-600`,
                border: `border-${t}-200`,
                borderStrong: `border-${t}-600`,
                borderHover: `hover:border-${t}-400`,
                ring: `focus:ring-${t}-500`,
                iconBg: `bg-${t}-50 text-${t}-600`,
                buttonPrimary: `bg-${t}-600 text-white hover:bg-${t}-700 shadow-md shadow-${t}-500/20`,
                tabActive: `border-${t}-600 text-${t}-700 bg-${t}-50/50`,
                sidebarActive: `bg-slate-800 text-white shadow-lg shadow-black/20`,
                sidebarHover: `hover:bg-slate-800 hover:text-white`
            };
            return maps[type] || '';
        };

        // --- Auth & Listeners ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                state.view = 'dashboard';
                setupListeners(user.uid);
            } else {
                if (state.unsubHotlinks) state.unsubHotlinks();
                if (state.unsubProjects) state.unsubProjects();
                if (state.unsubFiles) state.unsubFiles();
                
                state.user = null;
                state.view = 'login';
                state.projects = [];
                state.hotlinks = [];
                render();
            }
        });

        function setupListeners(uid) {
            const hotlinksRef = collection(db, 'users', uid, 'hotlinks');
            state.unsubHotlinks = onSnapshot(hotlinksRef, (snap) => {
                let items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Sort in memory by 'index' field, fallback to createdAt
                state.hotlinks = items.sort((a, b) => {
                    const idxA = a.index !== undefined ? a.index : 9999;
                    const idxB = b.index !== undefined ? b.index : 9999;
                    return idxA - idxB;
                });
                render();
            });

            const projectsRef = query(collection(db, 'users', uid, 'projects'), orderBy('createdAt', 'desc'));
            state.unsubProjects = onSnapshot(projectsRef, (snap) => {
                state.projects = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.activeProject) {
                    const fresh = state.projects.find(p => p.id === state.activeProject.id);
                    if (fresh) state.activeProject = fresh;
                    else {
                        state.activeProject = null;
                        state.view = 'dashboard';
                    }
                }
                render();
            });
        }

        function setupFileListener(projectId) {
            if (state.unsubFiles) state.unsubFiles();
            const filesRef = query(collection(db, 'users', state.user.uid, 'projects', projectId, 'files'), orderBy('createdAt', 'desc'));
            state.unsubFiles = onSnapshot(filesRef, (snap) => {
                state.activeProjectFiles = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
        }

        // --- Actions ---
        window.actions = {
            setTheme: (newTheme) => {
                state.theme = newTheme;
                localStorage.setItem('scholar_theme', newTheme);
                render();
            },

            toggleAuthMode: () => {
                state.authMode = state.authMode === 'login' ? 'signup' : 'login';
                render();
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const errorDiv = document.getElementById('auth-error');
                const btn = document.getElementById('auth-btn');
                
                errorDiv.classList.add('hidden');
                btn.disabled = true;
                btn.innerHTML = `<span class="inline-block animate-spin mr-2">⟳</span> Processing...`;

                try {
                    if (state.authMode === 'signup') {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error(err);
                    errorDiv.textContent = formatAuthError(err.code);
                    errorDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerText = state.authMode === 'login' ? 'Sign In' : 'Create Account';
                }
            },

            logout: async () => {
                await signOut(auth);
            },

            toggleSidebar: () => {
                state.sidebarOpen = !state.sidebarOpen;
                render();
            },
            
            setView: (view, project = null) => {
                state.view = view;
                if (project) {
                    state.activeProject = project;
                    state.projectSubTab = 'overview';
                    setupFileListener(project.id);
                } else {
                    state.activeProject = null;
                    state.activeProjectFiles = [];
                    if (state.unsubFiles) state.unsubFiles();
                }
                render();
            },

            setSubTab: (tab) => {
                state.projectSubTab = tab;
                render();
            },

            openModal: (type) => {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.remove('hidden');
                // Small delay for fade in
                setTimeout(() => {
                    content.innerHTML = getModalContent(type);
                    lucide.createIcons();
                    // Focus first input
                    const firstInput = content.querySelector('input, textarea');
                    if(firstInput) firstInput.focus();
                }, 10);
            },

            closeModal: () => {
                if (state.isUploading) return;
                document.getElementById('modal-overlay').classList.add('hidden');
            },

            addHotlink: async (e) => {
                e.preventDefault();
                const colorInputs = document.getElementsByName('color');
                let selectedColor = 'bg-white border-slate-200';
                for(let input of colorInputs) {
                    if(input.checked) selectedColor = input.value;
                }

                const newIndex = state.hotlinks.length;

                await addDoc(collection(db, 'users', state.user.uid, 'hotlinks'), {
                    title: e.target.title.value, 
                    url: e.target.url.value, 
                    color: selectedColor,
                    index: newIndex,
                    createdAt: serverTimestamp()
                });
                window.actions.closeModal();
            },

            deleteHotlink: async (id) => {
                if(confirm('Remove this shortcut?')) await deleteDoc(doc(db, 'users', state.user.uid, 'hotlinks', id));
            },

            // New: Handle reordering
            handleSort: async (evt) => {
                const newOrderIds = Array.from(evt.to.children).map(el => el.dataset.id);
                const batch = writeBatch(db);
                
                newOrderIds.forEach((id, index) => {
                    // Only update if index changed to save writes? 
                    // For simplicity and consistency, updating all affected is safer for manual index strategy
                    const ref = doc(db, 'users', state.user.uid, 'hotlinks', id);
                    batch.update(ref, { index: index });
                });

                try {
                    await batch.commit();
                } catch (e) {
                    console.error("Batch update failed", e);
                }
            },

            addProject: async (e) => {
                e.preventDefault();
                const form = e.target;
                const newProj = {
                    title: form.title.value, description: form.description.value, status: form.status.value, resources: [], createdAt: serverTimestamp()
                };
                const ref = await addDoc(collection(db, 'users', state.user.uid, 'projects'), newProj);
                window.actions.closeModal();
                window.actions.setView('project-detail', {id: ref.id, ...newProj});
            },

            updateProjectStatus: async (projectId, newStatus) => {
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', projectId), {
                    status: newStatus
                });
            },

            deleteProject: async (id) => {
                if(!confirm('Delete project and all data? This cannot be undone.')) return;
                
                // FORCE UI UPDATE: Optimistically switch to dashboard immediately.
                // This ensures the user isn't stuck on a deleted project view while waiting for Firebase.
                window.actions.setView('dashboard');
                
                try {
                    // Then perform the actual deletion
                    await deleteDoc(doc(db, 'users', state.user.uid, 'projects', id));
                } catch (error) {
                    console.error("Delete failed", error);
                    alert("There was an issue deleting the project. Please refresh.");
                }
            },

            addResource: async (e) => {
                e.preventDefault();
                const newResource = { id: crypto.randomUUID(), title: e.target.title.value, url: e.target.url.value, createdAt: new Date().toISOString() };
                const updatedResources = [...(state.activeProject.resources || []), newResource];
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
                window.actions.closeModal();
            },

            deleteResource: async (resId) => {
                const updatedResources = state.activeProject.resources.filter(r => r.id !== resId);
                await updateDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id), { resources: updatedResources });
            },

            triggerFileUpload: () => document.getElementById('file-upload-input').click(),

            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;
                
                state.isUploading = true;
                const uploadContainer = document.getElementById('upload-ui-container');
                if (uploadContainer) {
                    uploadContainer.innerHTML = `
                        <div class="flex flex-col items-center py-12 animate-fade-in">
                            <div class="upload-spinner mb-4 ${getThemeClasses('text')}"></div>
                            <p class="text-sm font-semibold text-slate-800">Uploading "${file.name}"...</p>
                            <p class="text-xs text-slate-500 mt-1">Please do not close this window.</p>
                        </div>
                    `;
                }

                try {
                    const fileId = crypto.randomUUID();
                    const storagePath = `users/${state.user.uid}/projects/${state.activeProject.id}/${fileId}_${file.name}`;
                    const storageRef = ref(storage, storagePath);

                    await uploadBytes(storageRef, file);
                    const downloadUrl = await getDownloadURL(storageRef);

                    await addDoc(collection(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files'), {
                        name: file.name, 
                        type: file.type, 
                        size: file.size, 
                        url: downloadUrl,
                        storagePath: storagePath,
                        createdAt: serverTimestamp()
                    });

                    state.isUploading = false;
                    window.actions.closeModal();
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("Upload failed. Please try again.");
                    state.isUploading = false;
                    window.actions.closeModal();
                }
            },

            deleteFile: async (fileId, storagePath) => {
                if(!confirm('Delete file permanently?')) return;
                
                try {
                    if (storagePath) {
                        const fileRef = ref(storage, storagePath);
                        await deleteObject(fileRef).catch(e => console.warn("Storage delete failed", e));
                    }
                    await deleteDoc(doc(db, 'users', state.user.uid, 'projects', state.activeProject.id, 'files', fileId));
                } catch (error) {
                    console.error("Delete failed", error);
                }
            },

            downloadFile: (url, name, legacyData) => {
                const link = document.createElement('a');
                link.href = url || legacyData; 
                link.download = name;
                link.target = "_blank";
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link);
            }
        };

        function formatAuthError(code) {
            switch(code) {
                case 'auth/invalid-email': return 'Invalid email address.';
                case 'auth/user-disabled': return 'This user account has been disabled.';
                case 'auth/user-not-found': return 'No account found with this email.';
                case 'auth/wrong-password': return 'Incorrect password.';
                case 'auth/email-already-in-use': return 'Email is already registered.';
                case 'auth/weak-password': return 'Password must be at least 6 characters.';
                default: return 'Authentication failed. Please try again.';
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Active': return 'bg-emerald-100 text-emerald-800 border-emerald-200';
                case 'Planning': return 'bg-sky-100 text-sky-800 border-sky-200';
                case 'Completed': return 'bg-slate-100 text-slate-800 border-slate-200';
                case 'On Hold': return 'bg-amber-100 text-amber-800 border-amber-200';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- DOM Rendering ---
        function render() {
            const app = document.getElementById('app');
            if (state.view === 'loading') return;
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderSidebar()}
                    <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50/50 transition-colors duration-300">
                        <div class="flex-1 overflow-y-auto custom-scroll p-2">
                            ${state.view === 'dashboard' ? renderDashboard() : renderProjectDetail()}
                        </div>
                    </div>
                `;
                
                // Initialize Sortable if on dashboard
                if (state.view === 'dashboard') {
                    const grid = document.getElementById('hotlinks-grid');
                    if (grid) {
                        Sortable.create(grid, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            handle: '.drag-handle', // Handle specifically for dragging? or whole card
                            // making whole card draggable for better touch experience
                            delay: 100, // slight delay to prevent accidental drag on click
                            delayOnTouchOnly: true,
                            onEnd: function(evt) {
                                window.actions.handleSort(evt);
                            }
                        });
                    }
                }
            }
            lucide.createIcons();
        }

        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `
            <div class="min-h-screen w-full flex bg-white animate-fade-in relative overflow-hidden">
                <!-- Left Aesthetic Side -->
                <div class="hidden lg:flex lg:w-1/2 bg-slate-900 relative items-center justify-center p-12 overflow-hidden">
                    <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.15) 1px, transparent 0); background-size: 32px 32px;"></div>
                    <div class="absolute top-0 right-0 w-96 h-96 bg-teal-500/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2"></div>
                    
                    <div class="relative z-10 max-w-lg">
                        <div class="w-16 h-16 bg-gradient-to-br from-teal-400 to-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-2xl mb-8">
                            <i data-lucide="layout" class="w-8 h-8"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-white mb-6 leading-tight">Your Intelligent Research Workspace</h1>
                        <p class="text-slate-400 text-lg leading-relaxed">Manage your projects, resources, and findings in one centralized, distraction-free environment designed for scholars.</p>
                        
                        <div class="mt-12 flex gap-4 text-slate-500">
                            <div class="flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5 text-teal-400"></i> Secure</div>
                            <div class="flex items-center gap-2"><i data-lucide="zap" class="w-5 h-5 text-teal-400"></i> Fast</div>
                            <div class="flex items-center gap-2"><i data-lucide="cloud" class="w-5 h-5 text-teal-400"></i> Cloud Sync</div>
                        </div>
                    </div>
                </div>

                <!-- Right Form Side -->
                <div class="w-full lg:w-1/2 flex items-center justify-center p-8 lg:p-12">
                    <div class="w-full max-w-md">
                        <div class="lg:hidden mb-8 text-center">
                             <div class="w-12 h-12 bg-teal-600 rounded-lg flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
                                <i data-lucide="layout" class="w-6 h-6"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800">ScholarDash</h2>
                        </div>
                        
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-slate-900">${isLogin ? 'Welcome back' : 'Create account'}</h2>
                            <p class="text-slate-500 mt-2">${isLogin ? 'Enter your credentials to access your workspace.' : 'Start your research journey today.'}</p>
                        </div>
                        
                        <form onsubmit="actions.handleAuth(event)" class="space-y-5">
                            <div id="auth-error" class="hidden bg-red-50 text-red-600 text-sm p-4 rounded-lg border border-red-100 flex items-start gap-2">
                                <i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i>
                                <span></span>
                            </div>
                            
                            <div class="space-y-1.5">
                                <label class="block text-sm font-medium text-slate-700">Email Address</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <i data-lucide="mail" class="w-4 h-4"></i>
                                    </div>
                                    <input type="email" name="email" required class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all bg-slate-50 focus:bg-white" placeholder="you@academic.edu">
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="block text-sm font-medium text-slate-700">Password</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <i data-lucide="lock" class="w-4 h-4"></i>
                                    </div>
                                    <input type="password" name="password" required minlength="6" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-all bg-slate-50 focus:bg-white" placeholder="••••••••">
                                </div>
                            </div>

                            <button type="submit" id="auth-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3 rounded-lg transition-all duration-200 shadow-lg shadow-slate-900/10 flex justify-center items-center">
                                ${isLogin ? 'Sign In' : 'Create Account'} <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                            </button>
                        </form>

                        <div class="mt-8 pt-6 border-t border-slate-100 text-center text-sm text-slate-500">
                            <span>${isLogin ? "New to ScholarDash?" : "Already have an account?"}</span>
                            <button onclick="actions.toggleAuthMode()" class="text-teal-600 font-semibold hover:text-teal-700 hover:underline ml-1 transition-colors">
                                ${isLogin ? 'Create free account' : 'Sign in here'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderSidebar() {
            const widthClass = state.sidebarOpen ? 'w-64' : 'w-[80px]';
            const hideText = !state.sidebarOpen ? 'hidden' : '';
            const justifyClass = !state.sidebarOpen ? 'justify-center' : '';
            
            const renderThemeBubble = (color) => `
                <button onclick="actions.setTheme('${color}')" class="w-6 h-6 rounded-full bg-${color}-500 hover:scale-110 transition-transform ring-2 ${state.theme === color ? 'ring-slate-900 ring-offset-2' : 'ring-transparent'}" title="${color.charAt(0).toUpperCase() + color.slice(1)}"></button>
            `;

            return `
            <div class="bg-white text-slate-600 flex-shrink-0 transition-all duration-300 flex flex-col ${widthClass} border-r border-slate-200 z-20 h-full relative">
                <!-- Brand -->
                <div class="h-20 flex items-center px-6 mb-2 border-b border-slate-100">
                    <div class="w-10 h-10 ${getThemeClasses('bg')} rounded-xl flex items-center justify-center text-white flex-shrink-0 shadow-lg shadow-${state.theme}-900/10">
                        <i data-lucide="layout" class="w-5 h-5"></i>
                    </div>
                    <div class="ml-3 ${hideText} overflow-hidden whitespace-nowrap">
                        <span class="font-bold text-slate-800 text-lg tracking-tight">Scholar</span><span class="${getThemeClasses('text')} font-bold text-lg">Dash</span>
                    </div>
                </div>

                <!-- Main Nav -->
                <div class="px-4 space-y-2 flex-1 overflow-y-auto overflow-x-hidden custom-scroll py-6">
                    <button onclick="actions.setView('dashboard')" class="w-full flex items-center ${justifyClass} gap-3 px-3 py-3 rounded-xl transition-all duration-200 group ${state.view === 'dashboard' ? getThemeClasses('sidebarActive') : 'hover:bg-slate-50 text-slate-500 hover:text-slate-800'}">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        <span class="${hideText} font-medium">Dashboard</span>
                    </button>
                    
                    <div class="mt-8 mb-3 px-3 flex items-center justify-between text-xs font-bold uppercase tracking-widest text-slate-400 ${hideText}">
                        <span>Projects</span>
                        <span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${state.projects.length}</span>
                    </div>
                    
                    ${state.projects.length === 0 && state.sidebarOpen ? `<div class="px-3 text-xs text-slate-400 italic">No projects created</div>` : ''}

                    <div class="space-y-1">
                        ${state.projects.slice(0, 10).map(p => `
                            <button onclick="actions.setView('project-detail', ${JSON.stringify(p).replace(/"/g, '&quot;')})" 
                                class="w-full flex items-center ${justifyClass} gap-3 px-3 py-2.5 rounded-xl transition-all duration-200 group relative ${state.activeProject?.id === p.id ? 'bg-slate-100 text-slate-900 font-semibold' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'}" title="${p.title}">
                                <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 border-2 border-white shadow-sm ${p.status === 'Active' ? 'bg-emerald-500' : 'bg-slate-400'}"></div>
                                <span class="truncate text-sm ${hideText}">${p.title}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- User Profile & Theme -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <div class="${hideText} mb-6 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-3 text-center">Appearance</p>
                        <div class="flex justify-center gap-2">
                            ${renderThemeBubble('teal')}
                            ${renderThemeBubble('indigo')}
                            ${renderThemeBubble('violet')}
                            ${renderThemeBubble('rose')}
                            ${renderThemeBubble('amber')}
                        </div>
                    </div>

                    <div class="flex items-center gap-3 mb-2 px-2">
                         <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 font-bold shrink-0">
                            ${state.user.email.charAt(0).toUpperCase()}
                        </div>
                        <div class="${hideText} overflow-hidden">
                             <p class="text-xs font-medium text-slate-900 truncate">${state.user.email.split('@')[0]}</p>
                             <p class="text-[10px] text-slate-400 truncate">Pro Account</p>
                        </div>
                        <button onclick="actions.logout()" class="ml-auto text-slate-400 hover:text-red-500 transition-colors ${hideText}" title="Sign Out">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <button onclick="actions.toggleSidebar()" class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-white border border-slate-200 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-800 shadow-sm z-30 hidden md:flex">
                        <i data-lucide="${state.sidebarOpen ? 'chevron-left' : 'chevron-right'}" class="w-3 h-3"></i>
                    </button>
                     <button onclick="actions.toggleSidebar()" class="w-full flex md:hidden items-center justify-center p-2 text-slate-400 mt-2">
                        <i data-lucide="${state.sidebarOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderDashboard() {
            const activeCount = state.projects.filter(p => p.status === 'Active').length;
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            return `
            <div class="max-w-7xl mx-auto p-6 md:p-8 space-y-8 animate-fade-in pb-20">
                <!-- Header -->
                <header class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 pb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Overview</h1>
                        <p class="text-slate-500 mt-1 font-medium">Here's what's happening with your research.</p>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-slate-600 block bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm">${dateStr}</span>
                    </div>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i data-lucide="folder-open" class="w-24 h-24 text-slate-900"></i>
                        </div>
                        <div class="text-slate-500 font-medium text-sm uppercase tracking-wide">Total Projects</div>
                        <div class="text-4xl font-bold text-slate-800">${state.projects.length}</div>
                    </div>
                    <div class="bg-gradient-to-br from-white to-emerald-50/50 p-6 rounded-2xl border border-emerald-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i data-lucide="activity" class="w-24 h-24 text-emerald-600"></i>
                        </div>
                        <div class="text-emerald-600 font-medium text-sm uppercase tracking-wide">Active Studies</div>
                        <div class="text-4xl font-bold text-emerald-900">${activeCount}</div>
                    </div>
                     <div class="bg-gradient-to-br from-white to-${state.theme}-50/50 p-6 rounded-2xl border border-${state.theme}-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i data-lucide="zap" class="w-24 h-24 ${getThemeClasses('text')}"></i>
                        </div>
                        <div class="${getThemeClasses('text')} font-medium text-sm uppercase tracking-wide">Quick Access</div>
                        <div class="text-4xl font-bold ${getThemeClasses('textDark')}">${state.hotlinks.length}</div>
                    </div>
                </div>

                <!-- Hotlinks Section -->
                <section>
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-amber-500"></i> Quick Access</h2>
                         <button onclick="actions.openModal('hotlink')" class="text-xs font-semibold flex items-center gap-1.5 bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 transition-all shadow-md shadow-slate-900/10">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> Add
                        </button>
                    </div>
                    <div id="hotlinks-grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4">
                        ${state.hotlinks.map(link => `
                            <div data-id="${link.id}" class="drag-handle group relative ${link.color || 'bg-white border-slate-200'} border p-4 rounded-xl shadow-sm hover:shadow-lg transition-all duration-200 cursor-grab active:cursor-grabbing flex flex-col items-center text-center select-none h-32 justify-center">
                                <button onclick="actions.deleteHotlink('${link.id}')" class="absolute top-2 right-2 p-1 rounded-full hover:bg-black/5 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all z-10" onmousedown="event.stopPropagation()"><i data-lucide="x" class="w-3 h-3"></i></button>
                                <div class="absolute top-2 left-2 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="grip-vertical" class="w-3 h-3"></i></div>
                                
                                <a href="${link.url}" target="_blank" class="flex flex-col items-center w-full" onmousedown="event.stopPropagation()">
                                    <div class="w-10 h-10 mb-3 rounded-full bg-white/90 shadow-sm ring-1 ring-slate-100 flex items-center justify-center text-slate-500">
                                        <img src="https://www.google.com/s2/favicons?domain=${link.url}&sz=64" class="w-5 h-5 rounded-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                        <i data-lucide="globe" class="w-4 h-4 hidden"></i>
                                    </div>
                                    <span class="font-semibold text-slate-700 text-xs truncate w-full px-2">${link.title}</span>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <!-- Projects Grid -->
                <section>
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="layout-grid" class="w-4 h-4 text-slate-400"></i> All Projects</h2>
                        <button onclick="actions.openModal('project')" class="text-sm font-medium flex items-center gap-2 ${getThemeClasses('buttonPrimary')} px-4 py-2 rounded-lg transition-all transform hover:-translate-y-0.5">
                            <i data-lucide="plus" class="w-4 h-4"></i> New Project
                        </button>
                    </div>
                    
                    ${state.projects.length === 0 ? `
                        <div class="text-center py-20 bg-white border border-dashed border-slate-300 rounded-2xl">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300"><i data-lucide="folder-plus" class="w-8 h-8"></i></div>
                            <h3 class="text-lg font-medium text-slate-900">No projects yet</h3>
                            <p class="text-slate-500 mb-6 max-w-sm mx-auto mt-1">Create your first research project to start organizing your files and resources.</p>
                            <button onclick="actions.openModal('project')" class="text-sm font-semibold ${getThemeClasses('text')} hover:underline">Create Project</button>
                        </div>
                    ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.projects.map(p => `
                            <div onclick="actions.setView('project-detail', ${JSON.stringify(p).replace(/"/g, '&quot;')})" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 ${getThemeClasses('borderHover')} hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer group flex flex-col h-full">
                                <div class="flex justify-between items-start mb-4">
                                    <span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border ${getStatusColor(p.status)}">${p.status}</span>
                                    <span class="text-slate-300 ${getThemeClasses('textHover')} transition-colors transform group-hover:translate-x-1"><i data-lucide="arrow-right" class="w-5 h-5"></i></span>
                                </div>
                                <h3 class="font-bold text-lg text-slate-800 mb-2 leading-tight group-hover:${getThemeClasses('text')} transition-colors">${p.title}</h3>
                                <p class="text-slate-500 text-sm line-clamp-3 mb-6 flex-grow leading-relaxed">${p.description || '<span class="italic opacity-50">No description provided.</span>'}</p>
                                <div class="flex gap-4 text-xs text-slate-400 pt-4 border-t border-slate-100">
                                    <span class="flex items-center gap-1.5 font-medium"><i data-lucide="link" class="w-3.5 h-3.5"></i> ${p.resources ? p.resources.length : 0}</span>
                                    <span class="flex items-center gap-1.5 font-medium"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${p.createdAt?.seconds ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : 'New'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    `}
                </section>
            </div>`;
        }

        function renderProjectDetail() {
            const p = state.activeProject;
            
            const renderOverview = () => `
                <div class="max-w-3xl animate-slide-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 mb-6">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4 flex items-center gap-2"><i data-lucide="align-left" class="w-4 h-4"></i> Description</h3>
                        <p class="text-slate-700 leading-relaxed whitespace-pre-wrap text-base">${p.description || "No description provided for this project."}</p>
                    </div>
                </div>`;

            const renderResources = () => `
                <div class="max-w-5xl animate-slide-in">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Linked Resources</h3>
                        <button onclick="actions.openModal('resource')" class="flex items-center gap-2 text-sm font-medium ${getThemeClasses('bg')} text-white px-4 py-2 rounded-lg ${getThemeClasses('bgHover')} shadow-sm transition-all"><i data-lucide="plus" class="w-4 h-4"></i> Add Resource</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4 font-semibold text-slate-600 uppercase text-xs tracking-wider">Title</th>
                                    <th class="px-6 py-4 font-semibold text-slate-600 uppercase text-xs tracking-wider">Source</th>
                                    <th class="px-6 py-4 font-semibold text-slate-600 text-right uppercase text-xs tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${(!p.resources || p.resources.length === 0) ? `<tr><td colspan="3" class="px-6 py-12 text-center text-slate-400 italic">No resources linked yet. Add relevant URLs to track your research.</td></tr>` : ''}
                                ${(p.resources || []).map(r => `
                                    <tr class="hover:bg-slate-50/80 transition-colors group">
                                        <td class="px-6 py-4 font-medium text-slate-800">${r.title}</td>
                                        <td class="px-6 py-4"><a href="${r.url}" target="_blank" class="${getThemeClasses('text')} hover:underline flex items-center gap-1.5"><img src="https://www.google.com/s2/favicons?domain=${r.url}" class="w-3.5 h-3.5 opacity-70"> ${new URL(r.url).hostname}</a></td>
                                        <td class="px-6 py-4 text-right"><button onclick="actions.deleteResource('${r.id}')" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            const renderFiles = () => `
                <div class="max-w-5xl animate-slide-in">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Project Files</h3>
                        <button onclick="actions.openModal('file')" class="flex items-center gap-2 text-sm font-medium ${getThemeClasses('bg')} text-white px-4 py-2 rounded-lg ${getThemeClasses('bgHover')} shadow-sm transition-all"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload File</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4 font-semibold text-slate-600 uppercase text-xs tracking-wider">Name</th>
                                    <th class="px-6 py-4 font-semibold text-slate-600 uppercase text-xs tracking-wider">Size</th>
                                    <th class="px-6 py-4 font-semibold text-slate-600 uppercase text-xs tracking-wider text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${(state.activeProjectFiles.length === 0) ? `<tr><td colspan="3" class="px-6 py-12 text-center text-slate-400 italic">No files uploaded yet.</td></tr>` : ''}
                                ${state.activeProjectFiles.map(f => `
                                    <tr class="hover:bg-slate-50/80 transition-colors">
                                        <td class="px-6 py-4 font-medium text-slate-800 flex items-center gap-3">
                                            <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-500"><i data-lucide="file-text" class="w-4 h-4"></i></div>
                                            ${f.name}
                                        </td>
                                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${formatSize(f.size)}</td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="flex justify-end gap-2">
                                                <button onclick="actions.downloadFile('${f.url}', '${f.name}', '${f.data || ''}')" class="p-2 rounded hover:bg-slate-100 text-slate-400 ${getThemeClasses('textHover')} transition-colors" title="Download"><i data-lucide="download" class="w-4 h-4"></i></button>
                                                <button onclick="actions.deleteFile('${f.id}', '${f.storagePath || ''}')" class="p-2 rounded hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            const getSubContent = () => {
                if (state.projectSubTab === 'resources') return renderResources();
                if (state.projectSubTab === 'files') return renderFiles();
                return renderOverview();
            };

            return `
            <div class="flex flex-col h-full animate-fade-in">
                <!-- Project Header -->
                <div class="bg-white border-b border-slate-200 shadow-sm z-10 sticky top-0">
                    <div class="px-8 py-8">
                        <div class="flex justify-between items-start max-w-6xl mx-auto">
                            <div>
                                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-4 font-medium">
                                    <span onclick="actions.setView('dashboard')" class="hover:text-slate-800 cursor-pointer hover:underline transition-all">Projects</span>
                                    <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                                    <span class="${getThemeClasses('text')} px-2 py-0.5 rounded-md bg-slate-50">${p.title}</span>
                                </nav>
                                <div class="flex items-center gap-4">
                                    <h1 class="text-3xl font-bold text-slate-900 tracking-tight">${p.title}</h1>
                                    <div class="relative group">
                                         <select onchange="actions.updateProjectStatus('${p.id}', this.value)" class="appearance-none pl-3 pr-8 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider cursor-pointer outline-none focus:ring-2 focus:ring-offset-1 ${getThemeClasses('ring')} border ${getStatusColor(p.status)}">
                                            <option value="Active" ${p.status === 'Active' ? 'selected' : ''}>Active</option>
                                            <option value="Planning" ${p.status === 'Planning' ? 'selected' : ''}>Planning</option>
                                            <option value="Completed" ${p.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                            <option value="On Hold" ${p.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="w-3 h-3 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            <button onclick="actions.deleteProject('${p.id}')" class="text-sm text-red-600 hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors flex items-center gap-2 border border-transparent hover:border-red-100">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="px-8">
                        <div class="flex gap-1 max-w-6xl mx-auto">
                            ${['overview', 'resources', 'files'].map(t => `
                                <button onclick="actions.setSubTab('${t}')" class="px-6 py-3 text-sm font-medium border-b-2 transition-all capitalize relative top-[1px] ${state.projectSubTab === t ? getThemeClasses('tabActive') : 'border-transparent text-slate-500 hover:text-slate-800 hover:bg-slate-50' } rounded-t-lg">
                                    ${t}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="flex-1 overflow-y-auto bg-slate-50/50 p-8">
                    <div class="max-w-6xl mx-auto">
                        ${getSubContent()}
                    </div>
                </div>
            </div>`;
        }

        function getModalContent(type) {
            const header = (title, icon) => `
                <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${getThemeClasses('bgLight')} ${getThemeClasses('text')} flex items-center justify-center"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                        ${title}
                    </h3>
                    <button onclick="actions.closeModal()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1.5 rounded-full transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>`;
            
            const footer = (btnText) => `
                <div class="flex justify-end gap-3 mt-8 pt-5 border-t border-slate-100">
                    <button type="button" onclick="actions.closeModal()" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg text-sm font-medium transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 ${getThemeClasses('buttonPrimary')} rounded-lg text-sm font-medium transition-all transform hover:-translate-y-0.5">${btnText}</button>
                </div>`;
            
            const inputClass = `w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:bg-white outline-none transition-all ${getThemeClasses('ring')} focus:ring-2 focus:border-transparent`;
            const labelClass = `block text-xs font-bold uppercase tracking-wider text-slate-500 mb-1.5`;

            if (type === 'hotlink') {
                return `
                <form onsubmit="actions.addHotlink(event)">
                    ${header('Add Quick Link', 'link')}
                    <div class="p-6">
                        <div class="mb-5">
                            <label class="${labelClass}">Title</label>
                            <input name="title" required class="${inputClass}" placeholder="e.g. University Library">
                        </div>
                        <div class="mb-6">
                            <label class="${labelClass}">URL</label>
                            <input name="url" required class="${inputClass}" placeholder="https://...">
                        </div>
                        <div class="mb-2">
                            <label class="${labelClass} mb-3">Card Accent</label>
                            <div class="flex gap-4">
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="color" value="bg-white border-slate-200" checked class="peer sr-only">
                                    <div class="w-10 h-10 rounded-full bg-white border border-slate-300 shadow-sm peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-slate-400 group-hover:scale-105 transition-all"></div>
                                    <span class="absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-slate-400 opacity-0 peer-checked:opacity-100">None</span>
                                </label>
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="color" value="bg-rose-50 border-rose-100" class="peer sr-only">
                                    <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-200 shadow-sm peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-rose-400 group-hover:scale-105 transition-all"></div>
                                </label>
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="color" value="bg-amber-50 border-amber-100" class="peer sr-only">
                                    <div class="w-10 h-10 rounded-full bg-amber-50 border border-amber-200 shadow-sm peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-amber-400 group-hover:scale-105 transition-all"></div>
                                </label>
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="color" value="bg-emerald-50 border-emerald-100" class="peer sr-only">
                                    <div class="w-10 h-10 rounded-full bg-emerald-50 border border-emerald-200 shadow-sm peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-emerald-400 group-hover:scale-105 transition-all"></div>
                                </label>
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="color" value="bg-indigo-50 border-indigo-100" class="peer sr-only">
                                    <div class="w-10 h-10 rounded-full bg-indigo-50 border border-indigo-200 shadow-sm peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-indigo-400 group-hover:scale-105 transition-all"></div>
                                </label>
                            </div>
                        </div>
                        ${footer('Save Shortcut')}
                    </div>
                </form>`;
            }
            if (type === 'project') {
                return `
                <form onsubmit="actions.addProject(event)">
                    ${header('New Project', 'folder-plus')}
                    <div class="p-6">
                        <div class="mb-5">
                            <label class="${labelClass}">Project Title</label>
                            <input name="title" required class="${inputClass}" placeholder="e.g. Thesis Research">
                        </div>
                        <div class="mb-5">
                            <label class="${labelClass}">Description</label>
                            <textarea name="description" class="${inputClass} h-32 resize-none" placeholder="Brief overview of the project goals..."></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="${labelClass}">Initial Status</label>
                            <div class="relative">
                                <select name="status" class="${inputClass} appearance-none cursor-pointer">
                                    <option>Active</option>
                                    <option>Planning</option>
                                    <option>On Hold</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 pointer-events-none"></i>
                            </div>
                        </div>
                        ${footer('Create Project')}
                    </div>
                </form>`;
            }
            if (type === 'resource') {
                return `
                <form onsubmit="actions.addResource(event)">
                    ${header('Add Resource', 'link')}
                    <div class="p-6">
                        <div class="mb-5">
                            <label class="${labelClass}">Resource Title</label>
                            <input name="title" required class="${inputClass}" placeholder="e.g. Source Documentation">
                        </div>
                        <div class="mb-2">
                            <label class="${labelClass}">URL</label>
                            <input name="url" required class="${inputClass}" placeholder="https://...">
                        </div>
                        ${footer('Link Resource')}
                    </div>
                </form>`;
            }
            if (type === 'file') {
                return `
                <div id="upload-ui-container">
                    ${header('Upload File', 'upload-cloud')}
                    <div class="p-8 text-center">
                        <div onclick="actions.triggerFileUpload()" class="border-2 border-dashed border-slate-300 hover:border-${state.theme}-400 rounded-xl p-10 mb-6 cursor-pointer hover:bg-${state.theme}-50/50 transition-all group">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="upload" class="text-slate-400 ${getThemeClasses('textHover')} w-8 h-8 transition-colors"></i>
                            </div>
                            <p class="text-base font-semibold text-slate-700 mb-1">Click to select file</p>
                            <p class="text-xs text-slate-400">Documents, images, or archives</p>
                            <input type="file" id="file-upload-input" class="hidden" onchange="actions.handleFileUpload(this)">
                        </div>
                        <div class="flex justify-center">
                            <button onclick="actions.closeModal()" class="text-sm font-medium text-slate-500 hover:text-slate-800 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>`;
            }
        }
    </script>
</body>
</html>
